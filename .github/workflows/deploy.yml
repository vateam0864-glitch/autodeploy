name: Deploy via ZeroTier

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------
      # CHECKOUT REPOSITORY
      # ------------------------------
      - name: Checkout code
        uses: actions/checkout@v3

      # ------------------------------
      # ADD SSH PRIVATE KEY
      # ------------------------------
      - name: Add SSH private key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/github_actions_key
          chmod 600 ~/.ssh/github_actions_key

          # Disable strict host checking for this workflow
          echo -e "Host *\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

      # ------------------------------
      # INSTALL ZEROTIER ON RUNNER
      # ------------------------------
      - name: Install ZeroTier
        run: |
          curl -s https://install.zerotier.com | sudo bash

      # ------------------------------
      # JOIN ZEROTIER NETWORK
      # ------------------------------
      - name: Join ZeroTier Network
        run: |
          sudo zerotier-cli join ${{ secrets.ZT_NETWORK_ID }}

          # Wait until runner becomes ONLINE in ZeroTier
          for i in {1..20}; do
            STATUS=$(sudo zerotier-cli listnetworks | grep ${{ secrets.ZT_NETWORK_ID }} | awk '{print $4}')
            if [ "$STATUS" = "OK" ]; then
              echo "ZeroTier connected!"
              break
            fi
            echo "Waiting for ZeroTier... ($i/20)"
            sleep 3
          done

      # ------------------------------
      # TEST SSH CONNECTIVITY
      # ------------------------------
      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/github_actions_key dani@${{ secrets.ZT_HOST }} "echo 'SSH Connected Successfully!'"

      # ------------------------------
      # DEPLOY APPLICATION
      # ------------------------------
      - name: Deploy Application on Laptop
        run: |
          ssh -i ~/.ssh/github_actions_key dani@${{ secrets.ZT_HOST }} << 'EOF'
            set -e
            cd ~/APPY
            git pull
            docker compose down || true
            docker compose up --build -d
            echo "ðŸš€ Deployment complete!"
          EOF
